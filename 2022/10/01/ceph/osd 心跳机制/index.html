

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/R.png">
  <link rel="icon" href="/img/R.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Rui">
  <meta name="keywords" content="">
  
    <meta name="description" content="osd 心跳是什么，有什么功能作用心跳是什么？​	  心跳是一种用于故障检测的手段（简单的说就是发个数据包给你，通过有没有回复来判断你的状态）。在分布式系统中有很多节点，节点数量多了，各种异常就会经常发生，如：宕机、磁盘损坏、网络故障等，通过心跳这种机制可以快速有效的定位集群中的错误节点，并做及时的处理保证集群正常服务。 osd 心跳 osd是什么？  通俗理解为 主要负责管理ceph集群中磁盘">
<meta property="og:type" content="article">
<meta property="og:title" content="osd 心跳">
<meta property="og:url" content="http://example.com/2022/10/01/ceph/osd%20%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="Rui">
<meta property="og:description" content="osd 心跳是什么，有什么功能作用心跳是什么？​	  心跳是一种用于故障检测的手段（简单的说就是发个数据包给你，通过有没有回复来判断你的状态）。在分布式系统中有很多节点，节点数量多了，各种异常就会经常发生，如：宕机、磁盘损坏、网络故障等，通过心跳这种机制可以快速有效的定位集群中的错误节点，并做及时的处理保证集群正常服务。 osd 心跳 osd是什么？  通俗理解为 主要负责管理ceph集群中磁盘">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://img.rui.vin/202209190006673.png">
<meta property="article:published_time" content="2022-10-01T13:11:39.000Z">
<meta property="article:modified_time" content="2022-10-16T09:30:24.667Z">
<meta property="article:author" content="Rui">
<meta property="article:tag" content="ceph">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://img.rui.vin/202209190006673.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>osd 心跳 - Rui</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.1","typing":{"enable":true,"typeSpeed":70,"cursorChar":".","loop":false,"scope":[],"Options":"home | post | tag | category | about | links | page | 404"},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"C++"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":"ture","follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Rui</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://api.dujin.org/bing/1366.php') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="osd 心跳"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-01 21:11" pubdate>
          October 1, 2022 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          39k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          325 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">osd 心跳</h1>
            
            <div class="markdown-body">
              
              <hr>
<h2 id="osd-心跳是什么，有什么功能作用"><a href="#osd-心跳是什么，有什么功能作用" class="headerlink" title="osd 心跳是什么，有什么功能作用"></a>osd 心跳是什么，有什么功能作用</h2><h3 id="心跳是什么？"><a href="#心跳是什么？" class="headerlink" title="心跳是什么？"></a>心跳是什么？</h3><p>​	  心跳是一种用于故障检测的手段（简单的说就是发个数据包给你，通过有没有回复来判断你的状态）。在分布式系统中有很多节点，节点数量多了，各种异常就会经常发生，如：宕机、<strong>磁盘损坏</strong>、网络故障等，通过心跳这种机制可以快速有效的<strong>定位集群</strong>中的错误节点，并做及时的处理保证集群正常服务。</p>
<h3 id="osd-心跳"><a href="#osd-心跳" class="headerlink" title="osd 心跳"></a>osd 心跳</h3><ul>
<li><p><strong>osd是什么？</strong><br>  通俗理解为 主要负责管理ceph集群中磁盘的守护进程</p>
</li>
<li><p><strong>osd心跳是什么？有啥功能</strong></p>
<p>   osd心跳是检测osd故障的一种机制(集群健康工作的基石)， 如果集群中的其中一个osd 突然故障了（假如说是网络隔绝），此时他也没办法发信息给mon，那么此时只有通过其他 osd来上报这个信息，<strong>说我有个邻居挂掉了</strong>，那么osd是怎么确定他邻居osd已经出故障了呢？</p>
</li>
</ul>
<h3 id="osd之间检测"><a href="#osd之间检测" class="headerlink" title="osd之间检测"></a>osd之间检测</h3><ol>
<li><p>每个 Ceph OSD 守护进程以小于每 6 秒的随机间隔时间检查其他 Ceph OSD 守护进程的心跳<strong>（可以理解为：定期去敲邻居的门）</strong></p>
<p><img src="http://img.rui.vin/202209190006673.png" alt="image-20220919000635555" style="zoom: 50%;">·</p>
</li>
<li><p>如果一个相邻的Ceph OSD Daemon在20秒的宽限期内没有显示心跳，Ceph OSD Daemon可能会认为相邻的Ceph OSD Daemon是 dowm状态的，并将其报告给Ceph Monitor<strong>（可以理解为：敲了那么长时间的门都没来开门,就报警了）</strong></p>
<img src="http://img.rui.vin/202209190007902.png" alt="image-20220919000758792" style="zoom:50%;">	
</li>
<li><p>一个osd 无法和配置文件中的osd  达成 peer 关系，则这个osd 每 30 秒 ping 一次mon 以获取集群的osdmap<br><img src="http://img.rui.vin/202209151612621.png" alt="image-20220915161221587"></p>
</li>
<li><p>如果集群只有一个osd，则 osd每隔 一个 <strong>osd_mon_heartbeat_interval</strong>   的时间向  mon 获取新的 osdmap</p>
</li>
</ol>
<h3 id="osd和mon之间"><a href="#osd和mon之间" class="headerlink" title="osd和mon之间"></a>osd和mon之间</h3><p>此外 osd除了有检测osd故障的职责，还需要向mon汇报自身的状况</p>
<p>触发汇报的情况有以下几种：</p>
<ul>
<li><p>OSD有事件发生时（比如故障、PG变更）。</p>
</li>
<li><p>osd启动时5秒内</p>
</li>
<li><p>OSD周期性的上报 mon （无论是否发现变化 ，默认周期120s）</p>
</li>
<li><p>OSD检查failure_queue中的伙伴OSD失败信息。</p>
</li>
</ul>
<h2 id="那些场景需要用到"><a href="#那些场景需要用到" class="headerlink" title="那些场景需要用到"></a>那些场景需要用到</h2><p>查看 mon的日志，看丢失的心跳包：<br>    osd心跳是一直伴随着集群存在的，也是检验集群健康的标志之一，</p>
<p>调整osd心跳 的参数：<br>    检查其它 osd 心跳的时间间隔，心跳响应宽限期，这些都会影响业务；故障的发现时间和心跳带来的负载之间做权衡，比如大规模的集群中， 心跳频率太高则过多的心跳报文会影响系统性能，如果心跳频率过低则会延长发现故障节点的时间，从而影响系统的可用性。</p>
<h2 id="基本使用（参数配置）"><a href="#基本使用（参数配置）" class="headerlink" title="基本使用（参数配置）"></a>基本使用（参数配置）</h2><p>osd心跳是集群正常工作的基石，osd的心跳的使用一般都是通过调节参数来到性能上的平衡，以下是 osd心跳机制的 参数，可以用 ceph daemon 命令设置</p>
<p>这里补充比较重要的参数（修改可以在 使用adminsocket 在线修改参数，当然也可以在 ceph.conf 中修改添加参数后重启 ）</p>
<p><strong>osd_mon_heartbeat_interval</strong><br>如果 Ceph OSD 守护进程没有 Ceph OSD 守护进程对等点，Ceph OSD 守护进程对 Ceph 监视器执行 ping 操作的频率。</p>
<p><strong>osd_heartbeat_interval</strong><br>Ceph OSD 守护进程 ping 其对等节点的频率（默认为6s）。</p>
<p><strong>osd_heartbeat_grace</strong><br>当Ceph OSD Daemon没有显示心跳时，Ceph 认为它已经停机的时间 (默认为20s)</p>
<p><strong>mon_osd_min_down_reporters</strong> (一般为2 )<br>报告故障的OSD 所需的最小数量 </p>
<p><strong>mon_osd_reporter_subtree_level</strong><br>设置报告故障的OSD 来自那个故障域的，默认为 host；默认情况下只需要两个来自不同故障域的报告就可以报告另一个OSD为停机</p>
<p><strong>osd_heartbeat_min_peers</strong><br>每次要发送心跳包对象的个数，默认 10个 </p>
<p><strong>osd_mon_report_interval</strong> 默认 5s<br>OSD 启动或其它可报告事件的报告间隔时间</p>
<p><strong>osd_beacon_report_interval</strong><br>osd周期性向 monitor发送 beacon消息进行保活 默认100s </p>
<p><strong>mon_osd_report_timeout</strong><br>mon标记一个osd为down的最长等待时间   默认值 900  </p>
<p>osd_mon_heartbeat_stat_stale<br>如果发送它将每 30 秒 ping 一次 Ceph 监视器以获取集群映射的最新副本…..</p>
<h2 id="模块组成以及实现架构"><a href="#模块组成以及实现架构" class="headerlink" title="模块组成以及实现架构"></a>模块组成以及实现架构</h2><h3 id="关键的数据结构"><a href="#关键的数据结构" class="headerlink" title="关键的数据结构"></a>关键的数据结构</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// information about a heartbeat peer </span><br><span class="hljs-comment">//这个类 用来记录 peer osd 信息以及 关于heartbeat 的操作函数都在这</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">HeartbeatInfo</span> &#123;<br> <span class="hljs-type">int</span> peer;           <span class="hljs-comment">///&lt; peer</span><br>    ConnectionRef con_front;   <span class="hljs-comment">///&lt; peer connection (front)</span><br>    ConnectionRef con_back;    <span class="hljs-comment">///&lt; peer connection (back)</span><br>    <span class="hljs-type">utime_t</span> first_tx;   <span class="hljs-comment">///&lt; time we sent our first ping request</span><br>    <span class="hljs-type">utime_t</span> last_tx;    <span class="hljs-comment">///&lt; last time we sent a ping request</span><br>    <span class="hljs-type">utime_t</span> last_rx_front;  <span class="hljs-comment">///&lt; last time we got a ping reply on the front side</span><br>    <span class="hljs-type">utime_t</span> last_rx_back;   <span class="hljs-comment">///&lt; last time we got a ping reply on the back side</span><br>    <span class="hljs-type">epoch_t</span> epoch;      <span class="hljs-comment">///&lt; most recent epoch we wanted this peer</span><br>    <span class="hljs-comment">/// number of connections we send and receive heartbeat pings/replies</span><br>    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> HEARTBEAT_MAX_CONN = <span class="hljs-number">2</span>;<br>    <span class="hljs-comment">/// history of inflight pings, arranging by timestamp we sent</span><br>    <span class="hljs-comment">/// send time -&gt; deadline -&gt; remaining replies</span><br>    map&lt;<span class="hljs-type">utime_t</span>, pair&lt;<span class="hljs-type">utime_t</span>, <span class="hljs-type">int</span>&gt;&gt; ping_history;<br>    <br>    <span class="hljs-comment">//这个map保存了 peer osd的heartbeat_peers，key是 osd的 id</span><br>    map&lt;<span class="hljs-type">int</span>,HeartbeatInfo&gt; heartbeat_peers;  <span class="hljs-comment">///&lt; map of osd id to HeartbeatInfo</span><br><span class="hljs-comment">//  ....</span><br> &#125;  <br></code></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// osd 接受心跳消息的handle 函数</span><br><span class="hljs-comment">// 在 class OSD 里面</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">HeartbeatDispatcher</span> : <span class="hljs-keyword">public</span> Dispatcher &#123;<br>    OSD *osd;<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">HeartbeatDispatcher</span><span class="hljs-params">(OSD *o)</span> : Dispatcher(o-&gt;cct), osd(o) &#123;</span>&#125;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ms_fast_dispatch</span><span class="hljs-params">(Message *m)</span> <span class="hljs-keyword">override</span> </span>&#123;<br>      osd-&gt;<span class="hljs-built_in">heartbeat_dispatch</span>(m);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ms_dispatch</span><span class="hljs-params">(Message *m)</span> <span class="hljs-keyword">override</span> </span>&#123;<br>      <span class="hljs-keyword">return</span> osd-&gt;<span class="hljs-built_in">heartbeat_dispatch</span>(m);<br>    &#125;<br><span class="hljs-comment">//........................</span><br>    <span class="hljs-function">KeyStore *<span class="hljs-title">ms_get_auth1_authorizer_keystore</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>&#123;<br>      <span class="hljs-keyword">return</span> osd-&gt;<span class="hljs-built_in">ms_get_auth1_authorizer_keystore</span>();<br>    &#125;<br>  &#125; heartbeat_dispatcher;<br></code></pre></td></tr></table></figure>



<h2 id="整体设计-流程"><a href="#整体设计-流程" class="headerlink" title="整体设计 流程"></a>整体设计 流程</h2><h3 id="osd-如何发送和接受心跳的"><a href="#osd-如何发送和接受心跳的" class="headerlink" title="osd 如何发送和接受心跳的"></a>osd 如何发送和接受心跳的</h3><h4 id="public-network-和-cluster-network"><a href="#public-network-和-cluster-network" class="headerlink" title="public network  和 cluster network"></a>public network  和 cluster network</h4><p>​		osd 直接的通信数据需要通过 <strong>ceph网络层传输</strong>；  一般来说 ceph集群是 内外网分离的，集群内部通信用单独cluster network，客户端外部和集群通信也是单独用 <strong>public network</strong>（可以理解为用两张网卡）<br>​		ceph将osd间的副本数据、迁移数据的传输交由cluster network，将client和ceph后端的数据传输交由public network<img src="http://img.rui.vin/202209141758757.png" alt="image-20220914175829713">	</p>
<p>​	osd之间心跳通信使用了 四个message对象 （ceph中 用于通信的类在 osd 初始化时会创建，可以理解为一个专门负责派送某一种类型的快递员）用于osd心跳通信，分别是</p>
<ul>
<li><p><strong>ms_hb_front_client</strong> ： 用于向其他 osd 发送心跳</p>
</li>
<li><p><strong>ms_hb_back_client</strong>： 用于向其他 osd 发送心跳</p>
</li>
<li><p><strong>ms_hb_back_server</strong>： 用于接受他 osd 发送心跳</p>
</li>
<li><p><strong>ms_hb_front_server</strong>： 用于接收他 osd 发送心跳</p>
</li>
<li><p><strong>front</strong> 用的是public network，用于检测客户端网络连接问题，<strong>back</strong> 用的是 cluster network。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c++"># ceph_osd.cc<br><span class="hljs-comment">// 创建四个关于心跳的 message   </span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv)</span> </span>&#123;<br>  Messenger *ms_hb_back_client = Messenger::<span class="hljs-built_in">create</span>(g_ceph_context, cluster_msg_type,<br>					     <span class="hljs-type">entity_name_t</span>::<span class="hljs-built_in">OSD</span>(whoami), <span class="hljs-string">&quot;hb_back_client&quot;</span>,<br>					     <span class="hljs-built_in">getpid</span>(), Messenger::HEARTBEAT);<br>  Messenger *ms_hb_front_client = Messenger::<span class="hljs-built_in">create</span>(g_ceph_context, public_msg_type,<br>					     <span class="hljs-type">entity_name_t</span>::<span class="hljs-built_in">OSD</span>(whoami), <span class="hljs-string">&quot;hb_front_client&quot;</span>,<br>					     <span class="hljs-built_in">getpid</span>(), Messenger::HEARTBEAT);<br>  Messenger *ms_hb_back_server = Messenger::<span class="hljs-built_in">create</span>(g_ceph_context, cluster_msg_type,<br>						   <span class="hljs-type">entity_name_t</span>::<span class="hljs-built_in">OSD</span>(whoami), <span class="hljs-string">&quot;hb_back_server&quot;</span>,<br>						   <span class="hljs-built_in">getpid</span>(), Messenger::HEARTBEAT);<br>  Messenger *ms_hb_front_server = Messenger::<span class="hljs-built_in">create</span>(g_ceph_context, public_msg_type,<br>						    <span class="hljs-type">entity_name_t</span>::<span class="hljs-built_in">OSD</span>(whoami), <span class="hljs-string">&quot;hb_front_server&quot;</span>,<br>						    <span class="hljs-built_in">getpid</span>(), Messenger::HEARTBEAT)；<br> <span class="hljs-comment">//osd 初始化的类其参数就需要 关于 心跳的 Message　实例</span><br> osd = <span class="hljs-keyword">new</span> <span class="hljs-built_in">OSD</span>(g_ceph_context,<br>                store,<br>                whoami,<br>                ms_cluster,<br>                ms_public,<br>                ms_hb_front_client,<br>                ms_hb_back_client,<br>                ms_hb_front_server,<br>                ms_hb_back_server,<br>                ms_objecter,<br>                &amp;mc,<br>                data_path,<br>                journal_path);<br>    <br> <span class="hljs-comment">// 启动 message   </span><br>  ms_hb_front_client-&gt;<span class="hljs-built_in">start</span>();<br>  ms_hb_back_client-&gt;<span class="hljs-built_in">start</span>();<br>  ms_hb_front_server-&gt;<span class="hljs-built_in">start</span>();<br>  ms_hb_back_server-&gt;<span class="hljs-built_in">start</span>();          <br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<p><img src="http://img.rui.vin/202209161158998.png" alt="image-20220914175706661"><code>ms_hbclient &lt;-&gt; ms_hb_back_server</code> <code>ms_hbclient &lt;-&gt; ms_hb_front_server</code>。</p>
<h4 id="发送数据"><a href="#发送数据" class="headerlink" title="发送数据"></a>发送数据</h4><p><img src="http://img.rui.vin/202209191051040.png" alt="image-20220919105101754">	</p>
<p>osd 专门开了一个线程用来 发送心跳，遍历 heartbeat_peers ，逐个发送心跳包</p>
<p><img src="http://imt.rui.vin/202209251511916.png" alt="image-20220925151116385"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//解</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">T_Heartbeat</span> : <span class="hljs-keyword">public</span> Thread &#123;<br>    OSD *osd;<br>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">T_Heartbeat</span><span class="hljs-params">(OSD *o)</span> : osd(o) &#123;</span>&#125;<br>    <span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">entry</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>&#123;<br>        osd-&gt;<span class="hljs-built_in">heartbeat_entry</span>();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125; heartbeat_thread;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">OSD::init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// start the heartbeat thread</span><br><span class="hljs-comment">//传入的参数 是线程的名字</span><br>  heartbeat_thread.<span class="hljs-built_in">create</span>(<span class="hljs-string">&quot;osd_srv_heartbt&quot;</span>);<br><span class="hljs-comment">//....                                                              </span><br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OSD::heartbeat_entry</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-function">std::lock_guard <span class="hljs-title">l</span><span class="hljs-params">(heartbeat_lock)</span></span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_stopping</span>())<br>    <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">while</span> (!heartbeat_stop) &#123;<br>    <span class="hljs-built_in">heartbeat</span>();<br><br>    <span class="hljs-type">double</span> wait;<br>    <span class="hljs-comment">//等待的时间分为两种，一种是固定的 osd_heartbeat_interval，另外一种是 基于osd_heartbeat_interval生成的随机时间</span><br>    <span class="hljs-keyword">if</span> (cct-&gt;_conf.<span class="hljs-built_in">get_val</span>&lt;<span class="hljs-type">bool</span>&gt;(<span class="hljs-string">&quot;debug_disable_randomized_ping&quot;</span>)) &#123;<br>      wait = (<span class="hljs-type">float</span>)cct-&gt;_conf-&gt;osd_heartbeat_interval;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      wait = <span class="hljs-number">.5</span> + ((<span class="hljs-type">float</span>)(<span class="hljs-built_in">rand</span>() % <span class="hljs-number">10</span>)/<span class="hljs-number">10.0</span>) * (<span class="hljs-type">float</span>)cct-&gt;_conf-&gt;osd_heartbeat_interval;<br>    &#125;<br>    <span class="hljs-type">utime_t</span> w;<br>    <span class="hljs-comment">//转换成 utime_t</span><br>    w.<span class="hljs-built_in">set_from_double</span>(wait);<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">30</span>) &lt;&lt; <span class="hljs-string">&quot;heartbeat_entry sleeping for &quot;</span> &lt;&lt; wait &lt;&lt; dendl;<br><br>    <span class="hljs-comment">// 这里用条件变量来等待时间，并没有释放锁 </span><br>    heartbeat_cond.<span class="hljs-built_in">WaitInterval</span>(heartbeat_lock, w);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_stopping</span>())<br>      <span class="hljs-keyword">return</span>;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">30</span>) &lt;&lt; <span class="hljs-string">&quot;heartbeat_entry woke up&quot;</span> &lt;&lt; dendl;<br><br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>发送 heartbeat 过程都在    heartbeat(); 中 ，这里分析下</strong><br>heartbeat 函数主要为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OSD::heartbeat</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">ceph_assert</span>(heartbeat_lock.<span class="hljs-built_in">is_locked_by_me</span>());<br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">30</span>) &lt;&lt; <span class="hljs-string">&quot;heartbeat&quot;</span> &lt;&lt; dendl;<br><br>  <span class="hljs-comment">// get CPU load avg</span><br>  <span class="hljs-type">double</span> loadavgs[<span class="hljs-number">1</span>];<br>  <span class="hljs-type">int</span> hb_interval = cct-&gt;_conf-&gt;osd_heartbeat_interval;<br>  <span class="hljs-type">int</span> n_samples = <span class="hljs-number">86400</span>;<br>  <span class="hljs-keyword">if</span> (hb_interval &gt; <span class="hljs-number">1</span>) &#123;<br>    n_samples /= hb_interval;<br>    <span class="hljs-keyword">if</span> (n_samples &lt; <span class="hljs-number">1</span>)<br>      n_samples = <span class="hljs-number">1</span>;<br>  &#125;<br>  cout &lt;&lt; <span class="hljs-string">&quot;send times :  &quot;</span> &lt;&lt; n_samples &lt;&lt; std::endl;<br>  <span class="hljs-comment">// 估计下每次发送osd 负载值？？？？</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">getloadavg</span>(loadavgs, <span class="hljs-number">1</span>) == <span class="hljs-number">1</span>) &#123;<br>    cout &lt;&lt;loadavgs[<span class="hljs-number">0</span>] &lt;&lt; std::endl;<br>    logger-&gt;<span class="hljs-built_in">set</span>(l_osd_loadavg, <span class="hljs-number">100</span> * loadavgs[<span class="hljs-number">0</span>]);<br>    daily_loadavg = (daily_loadavg * (n_samples - <span class="hljs-number">1</span>) + loadavgs[<span class="hljs-number">0</span>]) / n_samples;<br><br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-string">&quot;heartbeat: daily_loadavg &quot;</span> &lt;&lt; daily_loadavg &lt;&lt; dendl;<br>  &#125;<br><br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-string">&quot;heartbeat checking stats&quot;</span> &lt;&lt; dendl;<br><br>  <span class="hljs-comment">// refresh peer list and osd stats</span><br>  <span class="hljs-comment">// hb_peers保存 id（这里是 osd 的id）</span><br>  vector&lt;<span class="hljs-type">int</span>&gt; hb_peers;<br><br>  <span class="hljs-comment">//遍历 peer osd, peer osd 如何更新在下面会说到</span><br>  <span class="hljs-keyword">for</span> (map&lt;<span class="hljs-type">int</span>,HeartbeatInfo&gt;::iterator p = heartbeat_peers.<span class="hljs-built_in">begin</span>();<br>       p != heartbeat_peers.<span class="hljs-built_in">end</span>();<br>       ++p)<br>    hb_peers.<span class="hljs-built_in">push_back</span>(p-&gt;first);<br><br>  <span class="hljs-comment">// 更新状态 osd 状态 </span><br>  <span class="hljs-keyword">auto</span> new_stat = service.<span class="hljs-built_in">set_osd_stat</span>(hb_peers, <span class="hljs-built_in">get_num_pgs</span>());<br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; __func__ &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; new_stat &lt;&lt; dendl;<br>  <span class="hljs-built_in">ceph_assert</span>(new_stat.statfs.total);<br><br><span class="hljs-comment">// 这比例指 osd 使用空间变更比例</span><br>  <span class="hljs-type">float</span> pratio;<br>  <span class="hljs-type">float</span> ratio = service.<span class="hljs-built_in">compute_adjusted_ratio</span>(new_stat, &amp;pratio);<br>  std::cout &lt;&lt; <span class="hljs-string">&quot;ratio :  &quot;</span> &lt;&lt; ratio &lt;&lt; std::endl; <br>  service.<span class="hljs-built_in">check_full_status</span>(ratio, pratio);<br><br><span class="hljs-comment">//获取当前实际  精确到纳秒</span><br>  <span class="hljs-type">utime_t</span> now = <span class="hljs-built_in">ceph_clock_now</span>();<br>  <span class="hljs-type">utime_t</span> deadline = now;<br><br><span class="hljs-comment">//deadline  最大等待回应的时间</span><br>  deadline += cct-&gt;_conf-&gt;osd_heartbeat_grace;<br>  std::cout &lt;&lt; <span class="hljs-string">&quot;now &quot;</span> &lt;&lt; now &lt;&lt; std::endl;<br>  std::cout &lt;&lt; <span class="hljs-string">&quot;deadline &quot;</span> &lt;&lt; deadline &lt;&lt; std::endl;<br><br>  <span class="hljs-comment">// send heartbeats</span><br>  <span class="hljs-comment">// 遍历 对等 peer，逐个发送</span><br>  <span class="hljs-keyword">for</span> (map&lt;<span class="hljs-type">int</span>,HeartbeatInfo&gt;::iterator i = heartbeat_peers.<span class="hljs-built_in">begin</span>();<br>       i != heartbeat_peers.<span class="hljs-built_in">end</span>();<br>       ++i) &#123;<br>    <span class="hljs-type">int</span> peer = i-&gt;first;<br>    i-&gt;second.last_tx = now;<br>    <span class="hljs-keyword">if</span> (i-&gt;second.first_tx == <span class="hljs-built_in">utime_t</span>())<br>      i-&gt;second.first_tx = now;<br>    <span class="hljs-comment">// 保存发送 heartbeat 记录，HEARTBEAT_MAX_CONN 为发送heartbeat 数量</span><br>    <span class="hljs-comment">//key 发送的时间和， value 为 心跳回复的期限 </span><br>    i-&gt;second.ping_history[now] = <span class="hljs-built_in">make_pair</span>(deadline,<br>      HeartbeatInfo::HEARTBEAT_MAX_CONN);<br>      <br>    <span class="hljs-keyword">if</span> (i-&gt;second.hb_interval_start == <span class="hljs-built_in">utime_t</span>())<br>      i-&gt;second.hb_interval_start = now;<br>      <br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-string">&quot;heartbeat sending ping to osd.&quot;</span> &lt;&lt; peer &lt;&lt; dendl;<br>    <span class="hljs-comment">//  集群内发送</span><br>    i-&gt;second.con_back-&gt;<span class="hljs-built_in">send_message</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">MOSDPing</span>(monc-&gt;<span class="hljs-built_in">get_fsid</span>(),<br>					  service.<span class="hljs-built_in">get_osdmap_epoch</span>(),<br>					  MOSDPing::PING, now,<br>					  cct-&gt;_conf-&gt;osd_heartbeat_min_size)); <br><br>   <span class="hljs-comment">// 如果有 设置 public network</span><br>    <span class="hljs-keyword">if</span> (i-&gt;second.con_front)<br>      i-&gt;second.con_front-&gt;<span class="hljs-built_in">send_message</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">MOSDPing</span>(monc-&gt;<span class="hljs-built_in">get_fsid</span>(),<br>					     service.<span class="hljs-built_in">get_osdmap_epoch</span>(),<br>					     MOSDPing::PING, now,<br>					  cct-&gt;_conf-&gt;osd_heartbeat_min_size));<br>  &#125;<br><span class="hljs-comment">//  MOSDPing::PING 心跳信息的类型，还有</span><br>  logger-&gt;<span class="hljs-built_in">set</span>(l_osd_hb_to, heartbeat_peers.<span class="hljs-built_in">size</span>());<br><span class="hljs-comment">// 如果集群只有一个 osd，他会在 osd_mon_heartbeat_interval 时间内，向mon获取新的 osdmap</span><br>  <span class="hljs-comment">// hmm.. am i all alone?</span><br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">30</span>) &lt;&lt; <span class="hljs-string">&quot;heartbeat lonely?&quot;</span> &lt;&lt; dendl;<br>  <span class="hljs-keyword">if</span> (heartbeat_peers.<span class="hljs-built_in">empty</span>()) &#123;<br>    <span class="hljs-keyword">if</span> (now - last_mon_heartbeat &gt; cct-&gt;_conf-&gt;osd_mon_heartbeat_interval &amp;&amp; <span class="hljs-built_in">is_active</span>()) &#123;<br>      last_mon_heartbeat = now;<br>      <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-string">&quot;i have no heartbeat peers; checking mon for new map&quot;</span> &lt;&lt; dendl;<br>      <span class="hljs-built_in">osdmap_subscribe</span>(<span class="hljs-built_in">get_osdmap_epoch</span>() + <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">30</span>) &lt;&lt; <span class="hljs-string">&quot;heartbeat done&quot;</span> &lt;&lt; dendl;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="更新-heartbeat-peers"><a href="#更新-heartbeat-peers" class="headerlink" title="更新 heartbeat_peers"></a>更新 heartbeat_peers</h4><p>osd 发送心跳包给peer osd，peer OSD的选择并不是集群中的全部osd，peer OSD如果选择其他所有结点，则会增加集群负载影响系统性能。peer OSD的选择是通过maybe_update_heartbeat_peers函数经行更新 heartbeat_peers；有以下三种情况会更新 heartbeat_peers：</p>
<ul>
<li>pg创建的时候，参见handle_pg_create；</li>
<li>osdmap变更时，参见handle_osd_map；</li>
<li>tick定时器会周期性的检测.</li>
</ul>
<p>osd 每次发送心跳的时候都需要遍历  heartbeat_peers， heartbeat_peers的 是个map，其 key 为osd的id，value是 HeartbeatInfo 结构体</p>
<p><code>map&lt;int,HeartbeatInfo&gt; heartbeat_peers;  ///&lt; map of osd id to HeartbeatInfo</code></p>
<h5 id="tick定时器会周期性的检测"><a href="#tick定时器会周期性的检测" class="headerlink" title="tick定时器会周期性的检测."></a>tick定时器会周期性的检测.</h5><p>ceph  使用了一个定时器来更新   <strong>heartbeat_peers</strong> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// tick</span><br><span class="hljs-comment">//get_tick_interval生成随机时间 在1s上下，不想让他太频繁</span><br><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">OSD::get_tick_interval</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// vary +/- 5% to avoid scrub scheduling livelocks</span><br>  <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> delta = <span class="hljs-number">0.05</span>;<br>  <span class="hljs-keyword">return</span> (OSD_TICK_INTERVAL *<br>	  ceph::util::<span class="hljs-built_in">generate_random_number</span>(<span class="hljs-number">1.0</span> - delta, <span class="hljs-number">1.0</span> + delta));<br>&#125;<br><span class="hljs-comment">// 在 int OSD::init()中有一个  tick_timer.add_event_after</span><br><span class="hljs-comment">// 从函数名 可看出 添加一个时间，在 get_tick_interval() 后执行事件</span><br>  tick_timer.<span class="hljs-built_in">add_event_after</span>(<span class="hljs-built_in">get_tick_interval</span>(),<br>			     <span class="hljs-keyword">new</span> <span class="hljs-built_in">C_Tick</span>(<span class="hljs-keyword">this</span>));<br><span class="hljs-comment">// 从 OSD::C_Tick 可以看出， 执行的是 osd-&gt;tick() 函数</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OSD</span>::C_Tick : <span class="hljs-keyword">public</span> Context &#123;<br>  OSD *osd;<br>  <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">C_Tick</span><span class="hljs-params">(OSD *o)</span> : osd(o) &#123;</span>&#125;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">finish</span><span class="hljs-params">(<span class="hljs-type">int</span> r)</span> <span class="hljs-keyword">override</span> </span>&#123;<br>    osd-&gt;<span class="hljs-built_in">tick</span>();<br>  &#125;<br>&#125;;<br><br></code></pre></td></tr></table></figure>



<p><strong>osd-&gt;tick()</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//对几种情况</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OSD::tick</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">ceph_assert</span>(osd_lock.<span class="hljs-built_in">is_locked</span>());<br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot;tick&quot;</span> &lt;&lt; dendl;<br><span class="hljs-comment">//等待 osd心跳健康，</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_active</span>() || <span class="hljs-built_in">is_waiting_for_healthy</span>()) &#123;<br> <span class="hljs-comment">//更新 heartbeat_peers</span><br>    <span class="hljs-built_in">maybe_update_heartbeat_peers</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_waiting_for_healthy</span>()) &#123;<br>    <span class="hljs-built_in">start_boot</span>();<br>  &#125;<br><span class="hljs-comment">//更新 osdmap epoch</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_waiting_for_healthy</span>() || <span class="hljs-built_in">is_booting</span>()) &#123;<br>    <span class="hljs-function">std::lock_guard <span class="hljs-title">l</span><span class="hljs-params">(heartbeat_lock)</span></span>;<br>    <span class="hljs-type">utime_t</span> now = <span class="hljs-built_in">ceph_clock_now</span>();<br>    <span class="hljs-keyword">if</span> (now - last_mon_heartbeat &gt; cct-&gt;_conf-&gt;osd_mon_heartbeat_interval) &#123;<br>      last_mon_heartbeat = now;<br>      <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt; __func__ &lt;&lt; <span class="hljs-string">&quot; checking mon for new map&quot;</span> &lt;&lt; dendl;<br>      <span class="hljs-built_in">osdmap_subscribe</span>(<span class="hljs-built_in">get_osdmap_epoch</span>() + <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-built_in">do_waiters</span>();<br><span class="hljs-comment">//继续添加 事件，循环调用  OSD::tick()</span><br>  tick_timer.<span class="hljs-built_in">add_event_after</span>(<span class="hljs-built_in">get_tick_interval</span>(), <span class="hljs-keyword">new</span> <span class="hljs-built_in">C_Tick</span>(<span class="hljs-keyword">this</span>));<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>OSD::tick 中 更新 heartbeat_peers 的关键函数是  maybe_update_heartbeat_peers()  这里简要分析下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OSD::maybe_update_heartbeat_peers</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">ceph_assert</span>(osd_lock.<span class="hljs-built_in">is_locked</span>());<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_waiting_for_healthy</span>() || <span class="hljs-built_in">is_active</span>()) &#123;<br>    <span class="hljs-type">utime_t</span> now = <span class="hljs-built_in">ceph_clock_now</span>();<br>    <span class="hljs-comment">//第一次启动时候</span><br>    <span class="hljs-keyword">if</span> (last_heartbeat_resample == <span class="hljs-built_in">utime_t</span>()) &#123;<br>      last_heartbeat_resample = now;<br>      <span class="hljs-built_in">heartbeat_set_peers_need_update</span>();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">heartbeat_peers_need_update</span>()) &#123;<br>      <span class="hljs-type">utime_t</span> dur = now - last_heartbeat_resample;<br>      <span class="hljs-comment">//仅仅在超出grace时间后才更新</span><br>      <span class="hljs-keyword">if</span> (dur &gt; cct-&gt;_conf-&gt;osd_heartbeat_grace) &#123;<br>	<span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot;maybe_update_heartbeat_peers forcing update after &quot;</span> &lt;&lt; dur &lt;&lt; <span class="hljs-string">&quot; seconds&quot;</span> &lt;&lt; dendl;<br>        <span class="hljs-comment">// 更新 peer的标志位</span><br>	<span class="hljs-built_in">heartbeat_set_peers_need_update</span>();<br>        <span class="hljs-comment">//// </span><br>	last_heartbeat_resample = now;<br>	<span class="hljs-comment">// automatically clean up any stale heartbeat peers</span><br>	<span class="hljs-comment">// if we are unhealthy, then clean all</span><br>        <span class="hljs-comment">//清空 peers</span><br>	<span class="hljs-built_in">reset_heartbeat_peers</span>(<span class="hljs-built_in">is_waiting_for_healthy</span>());<br>      &#125;<br>    &#125;<br>  &#125;<br><br><span class="hljs-comment">// ............</span><br>  <span class="hljs-comment">// build heartbeat from set</span><br>  <span class="hljs-comment">// 从同一个 pg下的osd中 获取 peer</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_active</span>()) &#123;<br>    vector&lt;PGRef&gt; pgs;<br>    _get_pgs(&amp;pgs);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; pg : pgs) &#123;<br>      pg-&gt;<span class="hljs-built_in">with_heartbeat_peers</span>([&amp;](<span class="hljs-type">int</span> peer) &#123;<br>	  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">get_osdmap</span>()-&gt;<span class="hljs-built_in">is_up</span>(peer)) &#123;<br>	    _add_heartbeat_peer(peer);<br>	  &#125;<br>	&#125;);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// include next and previous up osds to ensure we have a fully-connected set</span><br>  <span class="hljs-comment">//want: 保存 osd的相邻osd id，以防止 peer数量不够</span><br>  set&lt;<span class="hljs-type">int</span>&gt; want, extras;<br>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> next = <span class="hljs-built_in">get_osdmap</span>()-&gt;<span class="hljs-built_in">get_next_up_osd_after</span>(whoami);<br>  <span class="hljs-keyword">if</span> (next &gt;= <span class="hljs-number">0</span>)<br>    want.<span class="hljs-built_in">insert</span>(next);<br>  <span class="hljs-type">int</span> prev = <span class="hljs-built_in">get_osdmap</span>()-&gt;<span class="hljs-built_in">get_previous_up_osd_before</span>(whoami);<br>  <span class="hljs-keyword">if</span> (prev &gt;= <span class="hljs-number">0</span> &amp;&amp; prev != next)<br>    want.<span class="hljs-built_in">insert</span>(prev);<br><br>  <span class="hljs-comment">// make sure we have at least **min_down** osds coming from different</span><br>  <span class="hljs-comment">// subtree level (e.g., hosts) for fast failure detection.</span><br>  <span class="hljs-comment">// 确保至少有 min_down 个osd peer（理论上）， 从 level 故障域 和  min_down 从整个集群 随机抽取两个osd </span><br>  <span class="hljs-keyword">auto</span> min_down = cct-&gt;_conf.<span class="hljs-built_in">get_val</span>&lt;<span class="hljs-type">uint64_t</span>&gt;(<span class="hljs-string">&quot;mon_osd_min_down_reporters&quot;</span>);<br>  <span class="hljs-keyword">auto</span> subtree = cct-&gt;_conf.<span class="hljs-built_in">get_val</span>&lt;string&gt;(<span class="hljs-string">&quot;mon_osd_reporter_subtree_level&quot;</span>);<br><br>  <span class="hljs-built_in">get_osdmap</span>()-&gt;<span class="hljs-built_in">get_random_up_osds_by_subtree</span>(<br>    whoami, subtree, min_down, want, &amp;want);<br><br>  <span class="hljs-keyword">for</span> (set&lt;<span class="hljs-type">int</span>&gt;::iterator p = want.<span class="hljs-built_in">begin</span>(); p != want.<span class="hljs-built_in">end</span>(); ++p) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot; adding neighbor peer osd.&quot;</span> &lt;&lt; *p &lt;&lt; dendl;<br>    extras.<span class="hljs-built_in">insert</span>(*p);<br>    _add_heartbeat_peer(*p);<br>  &#125;<br>  <span class="hljs-comment">//删除已经down的osd</span><br>  <span class="hljs-comment">// remove down peers; enumerate extras</span><br>  map&lt;<span class="hljs-type">int</span>,HeartbeatInfo&gt;::iterator p = heartbeat_peers.<span class="hljs-built_in">begin</span>();<br>  <span class="hljs-keyword">while</span> (p != heartbeat_peers.<span class="hljs-built_in">end</span>()) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">get_osdmap</span>()-&gt;<span class="hljs-built_in">is_up</span>(p-&gt;first)) &#123;<br>      <span class="hljs-type">int</span> o = p-&gt;first;<br>      ++p;<br>      _remove_heartbeat_peer(o);<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (p-&gt;second.epoch &lt; <span class="hljs-built_in">get_osdmap_epoch</span>()) &#123;<br>      extras.<span class="hljs-built_in">insert</span>(p-&gt;first);<br>    &#125;<br>    ++p;<br>  &#125;<br><br>  <span class="hljs-comment">// too few?</span><br>  <span class="hljs-comment">//peer数量过少，默认 10个，从 want 里面添加</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> n = next; n &gt;= <span class="hljs-number">0</span>; ) &#123;<br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">int</span>)heartbeat_peers.<span class="hljs-built_in">size</span>() &gt;= cct-&gt;_conf-&gt;osd_heartbeat_min_peers)<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> (!extras.<span class="hljs-built_in">count</span>(n) &amp;&amp; !want.<span class="hljs-built_in">count</span>(n) &amp;&amp; n != whoami) &#123;<br>      <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot; adding random peer osd.&quot;</span> &lt;&lt; n &lt;&lt; dendl;<br>      extras.<span class="hljs-built_in">insert</span>(n);<br>      _add_heartbeat_peer(n);<br>    &#125;<br>    n = <span class="hljs-built_in">get_osdmap</span>()-&gt;<span class="hljs-built_in">get_next_up_osd_after</span>(n);<br>    <span class="hljs-keyword">if</span> (n == next)<br>      <span class="hljs-keyword">break</span>;  <span class="hljs-comment">// came full circle; stop</span><br>  &#125;<br><br>  <span class="hljs-comment">// too many?</span><br>  <span class="hljs-keyword">for</span> (set&lt;<span class="hljs-type">int</span>&gt;::iterator p = extras.<span class="hljs-built_in">begin</span>();<br>       (<span class="hljs-type">int</span>)heartbeat_peers.<span class="hljs-built_in">size</span>() &gt; cct-&gt;_conf-&gt;osd_heartbeat_min_peers &amp;&amp; p != extras.<span class="hljs-built_in">end</span>();<br>       ++p) &#123;<br>    <span class="hljs-keyword">if</span> (want.<span class="hljs-built_in">count</span>(*p))<br>      <span class="hljs-keyword">continue</span>;<br>    _remove_heartbeat_peer(*p);<br>  &#125;<br><br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot;maybe_update_heartbeat_peers &quot;</span> &lt;&lt; heartbeat_peers.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">&quot; peers, extras &quot;</span> &lt;&lt; extras &lt;&lt; dendl;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="pg创建的时候"><a href="#pg创建的时候" class="headerlink" title="pg创建的时候"></a>pg创建的时候</h5><p>在 函数 handle_pg_create 里最后也调用了 maybe_update_heartbeat_peers();</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OSD::handle_pg_create</span><span class="hljs-params">(OpRequestRef op)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">const</span> MOSDPGCreate *m = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">const</span> MOSDPGCreate*&gt;(op-&gt;<span class="hljs-built_in">get_req</span>());<br>  <span class="hljs-built_in">ceph_assert</span>(m-&gt;<span class="hljs-built_in">get_type</span>() == MSG_OSD_PG_CREATE);<br><br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot;handle_pg_create &quot;</span> &lt;&lt; *m &lt;&lt; dendl;<br> <span class="hljs-comment">//........................</span><br><br>  <span class="hljs-built_in">maybe_update_heartbeat_peers</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="osdmap-变更时候"><a href="#osdmap-变更时候" class="headerlink" title="osdmap 变更时候"></a>osdmap 变更时候</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OSD::handle_osd_map</span><span class="hljs-params">(MOSDMap *m)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">//..................</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_active</span>() || <span class="hljs-built_in">is_waiting_for_healthy</span>())<br>    <span class="hljs-built_in">maybe_update_heartbeat_peers</span>();<br>  <span class="hljs-comment">//..................</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="接收数据"><a href="#接收数据" class="headerlink" title="接收数据"></a>接收数据</h4><p>在 osd初始化时，创建四个关于心跳的 message,(上文有提到)， Message 类中 处理消息的方法 handle 会注册到分发中心</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//heartbeat_dispatcher 是一个结构体，里面有处理心跳信息的函数</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">OSD::init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>...<br><span class="hljs-comment">//注册dispatcher， heartbeat_dispatcher 处理心跳信息的函数</span><br>hb_front_client_messenger-&gt;<span class="hljs-built_in">add_dispatcher_head</span>(&amp;heartbeat_dispatcher);<br>hb_back_client_messenger-&gt;<span class="hljs-built_in">add_dispatcher_head</span>(&amp;heartbeat_dispatcher);<br>hb_front_server_messenger-&gt;<span class="hljs-built_in">add_dispatcher_head</span>(&amp;heartbeat_dispatcher);<br>hb_back_server_messenger-&gt;<span class="hljs-built_in">add_dispatcher_head</span>(&amp;heartbeat_dispatcher);<br>...<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// heartbeat_dispatch</span><br><span class="hljs-comment">// osd 收到心跳消息 的类型是 MSG_OSD_PING ，执行 handle_osd_ping</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">OSD::heartbeat_dispatch</span><span class="hljs-params">(Message *m)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">30</span>) &lt;&lt; <span class="hljs-string">&quot;heartbeat_dispatch &quot;</span> &lt;&lt; m &lt;&lt; dendl;<br>  <span class="hljs-keyword">switch</span> (m-&gt;<span class="hljs-built_in">get_type</span>()) &#123;<br><br>  <span class="hljs-keyword">case</span> CEPH_MSG_PING:<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot;ping from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_source_inst</span>() &lt;&lt; dendl;<br>    m-&gt;<span class="hljs-built_in">put</span>();<br>    <span class="hljs-keyword">break</span>;<br><br>  <span class="hljs-keyword">case</span> MSG_OSD_PING:<br>    <span class="hljs-built_in">handle_osd_ping</span>(<span class="hljs-built_in">static_cast</span>&lt;MOSDPing*&gt;(m));<br>    <span class="hljs-keyword">break</span>;<br><br>  <span class="hljs-keyword">default</span>:<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">0</span>) &lt;&lt; <span class="hljs-string">&quot;dropping unexpected message &quot;</span> &lt;&lt; *m &lt;&lt; <span class="hljs-string">&quot; from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_source_inst</span>() &lt;&lt; dendl;<br>    m-&gt;<span class="hljs-built_in">put</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里分析下  当 osd 收到心跳包后 handle_osd_ping是怎么处理的<br>处理的代码很长，主要可以分为三部分： 心跳通知、心跳回复、osd dowm，从这三个case 分析下</p>
<p><img src="http://img.rui.vin/202209201047067.png" alt="image-20220920104648238"></p>
<h5 id="处理心跳通知"><a href="#处理心跳通知" class="headerlink" title="处理心跳通知"></a>处理心跳通知</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//收到的是心跳通知 </span><br>  <span class="hljs-keyword">case</span> MOSDPing::PING:<br>    &#123;<br>      <span class="hljs-comment">//debug 模式</span><br>     <span class="hljs-comment">//这里判断是否超时</span><br>      <span class="hljs-keyword">if</span> (!cct-&gt;<span class="hljs-built_in">get_heartbeat_map</span>()-&gt;<span class="hljs-built_in">is_healthy</span>()) &#123;<br>		<span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot;internal heartbeat not healthy, dropping ping request&quot;</span> &lt;&lt; dendl;<br>		<span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-comment">//回复 心跳通知     </span><br>      Message *r = <span class="hljs-keyword">new</span> <span class="hljs-built_in">MOSDPing</span>(monc-&gt;<span class="hljs-built_in">get_fsid</span>(),<br>				curmap-&gt;<span class="hljs-built_in">get_epoch</span>(),<br>				MOSDPing::PING_REPLY, m-&gt;stamp,<br>				cct-&gt;_conf-&gt;osd_heartbeat_min_size);<br>      m-&gt;<span class="hljs-built_in">get_connection</span>()-&gt;<span class="hljs-built_in">send_message</span>(r);<br>      <span class="hljs-comment">//验证 发送方的osd是否 为 up       </span><br>      <span class="hljs-keyword">if</span> (curmap-&gt;<span class="hljs-built_in">is_up</span>(from)) &#123;<br>      <span class="hljs-comment">//  从收到消息中 更新osd peer的epoch</span><br>	service.<span class="hljs-built_in">note_peer_epoch</span>(from, m-&gt;map_epoch);<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_active</span>()) &#123;<br>	  ConnectionRef con = service.<span class="hljs-built_in">get_con_osd_cluster</span>(from, curmap-&gt;<span class="hljs-built_in">get_epoch</span>());<br>	  <span class="hljs-keyword">if</span> (con) &#123;<br>	    service.<span class="hljs-built_in">share_map_peer</span>(from, con.<span class="hljs-built_in">get</span>());<br>	  &#125;<br>	&#125;<br>      <span class="hljs-comment">//没有在 osdmap中发现你</span><br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!curmap-&gt;<span class="hljs-built_in">exists</span>(from) ||<br>		 curmap-&gt;<span class="hljs-built_in">get_down_at</span>(from) &gt; m-&gt;map_epoch) &#123;<br>	<span class="hljs-comment">// tell them they have died</span><br>	Message *r = <span class="hljs-keyword">new</span> <span class="hljs-built_in">MOSDPing</span>(monc-&gt;<span class="hljs-built_in">get_fsid</span>(),<br>				  curmap-&gt;<span class="hljs-built_in">get_epoch</span>(),<br>				  MOSDPing::YOU_DIED,<br>				  m-&gt;stamp,<br>				  cct-&gt;_conf-&gt;osd_heartbeat_min_size);<br>	m-&gt;<span class="hljs-built_in">get_connection</span>()-&gt;<span class="hljs-built_in">send_message</span>(r);<br>      &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>



<h5 id="处理心跳回复"><a href="#处理心跳回复" class="headerlink" title="处理心跳回复"></a>处理心跳回复</h5><p>处理函数太长了，大概看了下，主要功能是 根据时间戳更新 ping_history，更新peer对应的 HeartbeatInfo，以及 osd状态，这里没有心跳超时的检测，有一个定时任务专门负责</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>



<h4 id="心跳超时检测-和上报消息"><a href="#心跳超时检测-和上报消息" class="headerlink" title="心跳超时检测 和上报消息"></a>心跳超时检测 和上报消息</h4><p>心跳超时检测 在 OSD::init() </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">OSD::init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//.......</span><br>  tick_timer.<span class="hljs-built_in">add_event_after</span>(<span class="hljs-built_in">get_tick_interval</span>(),<br>			     <span class="hljs-keyword">new</span> <span class="hljs-built_in">C_Tick</span>(<span class="hljs-keyword">this</span>));<br>  &#123;<br>    <span class="hljs-function">std::lock_guard <span class="hljs-title">l</span><span class="hljs-params">(tick_timer_lock)</span></span>;<br>   <span class="hljs-comment">//每隔 get_tick_interval()时间  调C_Tick_WithoutOSDLock类里的 osd-&gt;tick_without_osd_lock() 函数</span><br>    tick_timer_without_osd_lock.<span class="hljs-built_in">add_event_after</span>(<span class="hljs-built_in">get_tick_interval</span>(),<br>						<span class="hljs-keyword">new</span> <span class="hljs-built_in">C_Tick_WithoutOSDLock</span>(<span class="hljs-keyword">this</span>));<br>  &#125;<br>    <span class="hljs-comment">//.......</span><br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OSD</span>::C_Tick_WithoutOSDLock : <span class="hljs-keyword">public</span> Context &#123;<br>  OSD *osd;<br>  <span class="hljs-keyword">public</span>:<br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">C_Tick_WithoutOSDLock</span><span class="hljs-params">(OSD *o)</span> : osd(o) &#123;</span>&#125;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">finish</span><span class="hljs-params">(<span class="hljs-type">int</span> r)</span> <span class="hljs-keyword">override</span> </span>&#123;<br>    osd-&gt;<span class="hljs-built_in">tick_without_osd_lock</span>();<br>  &#125;<br>&#125;;<br><br></code></pre></td></tr></table></figure>

<p>这里详细介绍下 <strong>tick_without_osd_lock</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OSD::tick_without_osd_lock</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br> <span class="hljs-comment">//......</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_active</span>() || <span class="hljs-built_in">is_waiting_for_healthy</span>()) &#123;<br>    heartbeat_lock.<span class="hljs-built_in">Lock</span>();<br>    <span class="hljs-comment">//关键函数 heartbeat_check</span><br>    <span class="hljs-comment">//heartbeat_check 会将 有错误的peer都会记录到 failure_queue</span><br>    <span class="hljs-built_in">heartbeat_check</span>();<br>    heartbeat_lock.<span class="hljs-built_in">Unlock</span>();<br><br>    map_lock.<span class="hljs-built_in">get_read</span>();<br>    <span class="hljs-function">std::lock_guard <span class="hljs-title">l</span><span class="hljs-params">(mon_report_lock)</span></span>;<br><br>    <span class="hljs-comment">// mon report?</span><br>    <span class="hljs-type">utime_t</span> now = <span class="hljs-built_in">ceph_clock_now</span>();<br>    <span class="hljs-keyword">if</span> (service.<span class="hljs-built_in">need_fullness_update</span>() ||<br>	now - last_mon_report &gt; cct-&gt;_conf-&gt;osd_mon_report_interval) &#123;<br>      last_mon_report = now;<br>      <span class="hljs-built_in">send_full_update</span>();<br>      <span class="hljs-comment">//send_failures 会遍历 failure_queue，然后将错误的消息发送给 mon</span><br>      <span class="hljs-built_in">send_failures</span>();<br>    &#125;<br>    map_lock.<span class="hljs-built_in">put_read</span>();<br><br>    <span class="hljs-type">epoch_t</span> max_waiting_epoch = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> s : shards) &#123;<br>      max_waiting_epoch = std::<span class="hljs-built_in">max</span>(max_waiting_epoch,<br>				   s-&gt;<span class="hljs-built_in">get_max_waiting_epoch</span>());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (max_waiting_epoch &gt; <span class="hljs-built_in">get_osdmap</span>()-&gt;<span class="hljs-built_in">get_epoch</span>()) &#123;<br>      <span class="hljs-built_in">dout</span>(<span class="hljs-number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="hljs-string">&quot; max_waiting_epoch &quot;</span> &lt;&lt; max_waiting_epoch<br>	       &lt;&lt; <span class="hljs-string">&quot;, requesting new map&quot;</span> &lt;&lt; dendl;<br>      <span class="hljs-built_in">osdmap_subscribe</span>(superblock.newest_map + <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_active</span>()) &#123;<br> .....<br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> now = ceph::coarse_mono_clock::<span class="hljs-built_in">now</span>();<br>    &#123;<br><span class="hljs-comment">//    周期性的向 mon报告</span><br>        std::lock_guard l&#123;min_last_epoch_clean_lock&#125;;<br>      <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> elapsed = now - last_sent_beacon;<br>      <span class="hljs-keyword">if</span> (chrono::<span class="hljs-built_in">duration_cast</span>&lt;chrono::seconds&gt;(elapsed).<span class="hljs-built_in">count</span>() &gt;<br>        cct-&gt;_conf-&gt;osd_beacon_report_interval) &#123;<br>        need_send_beacon = <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (need_send_beacon) &#123;<br><span class="hljs-comment">//将自己当前的 eponch 发送给mon</span><br>      <span class="hljs-built_in">send_beacon</span>(now);<br>    &#125;<br>  &#125;<br>....<br><span class="hljs-comment">//更新 定时器任务</span><br>  tick_timer_without_osd_lock.<span class="hljs-built_in">add_event_after</span>(<span class="hljs-built_in">get_tick_interval</span>(),<br>					      <span class="hljs-keyword">new</span> <span class="hljs-built_in">C_Tick_WithoutOSDLock</span>(<span class="hljs-keyword">this</span>));<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="heartbeat-check"><a href="#heartbeat-check" class="headerlink" title="heartbeat_check"></a><strong>heartbeat_check</strong></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OSD::heartbeat_check</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">ceph_assert</span>(heartbeat_lock.<span class="hljs-built_in">is_locked</span>());<br>  <span class="hljs-type">utime_t</span> now = <span class="hljs-built_in">ceph_clock_now</span>();<br><br>  <span class="hljs-comment">// check for incoming heartbeats (move me elsewhere?)</span><br>  <span class="hljs-comment">// 遍历 heartbeat_peers </span><br>  <span class="hljs-keyword">for</span> (map&lt;<span class="hljs-type">int</span>,HeartbeatInfo&gt;::iterator p = heartbeat_peers.<span class="hljs-built_in">begin</span>();<br>       p != heartbeat_peers.<span class="hljs-built_in">end</span>();<br>       ++p) &#123;<br><br>    <span class="hljs-keyword">if</span> (p-&gt;second.first_tx == <span class="hljs-built_in">utime_t</span>()) &#123;<br>      <span class="hljs-built_in">dout</span>(<span class="hljs-number">30</span>) &lt;&lt; <span class="hljs-string">&quot;heartbeat_check we haven&#x27;t sent ping to osd.&quot;</span> &lt;&lt; p-&gt;first<br>               &lt;&lt; <span class="hljs-string">&quot; yet, skipping&quot;</span> &lt;&lt; dendl;<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>.....<br>    <span class="hljs-comment">// 收到回复后，都会根据接收时间 记录 ping_history里</span><br>    <span class="hljs-keyword">if</span> (p-&gt;second.<span class="hljs-built_in">is_unhealthy</span>(now)) &#123;<br>      <span class="hljs-type">utime_t</span> oldest_deadline = p-&gt;second.ping_history.<span class="hljs-built_in">begin</span>()-&gt;second.first;<br>      <span class="hljs-comment">//</span><br>      <span class="hljs-keyword">if</span> (p-&gt;second.last_rx_back == <span class="hljs-built_in">utime_t</span>() ||<br>	  p-&gt;second.last_rx_front == <span class="hljs-built_in">utime_t</span>()) &#123;<br>	<span class="hljs-comment">// fail</span><br>        <span class="hljs-comment">//有错误的peer都会记录到 failure_queue，会统一发送给mon</span><br>	failure_queue[p-&gt;first] = p-&gt;second.first_tx;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>.....<br>	<span class="hljs-comment">// fail</span><br>	failure_queue[p-&gt;first] = std::<span class="hljs-built_in">min</span>(p-&gt;second.last_rx_back, p-&gt;second.last_rx_front);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="mon-如何处理上报信息的"><a href="#mon-如何处理上报信息的" class="headerlink" title="mon 如何处理上报信息的"></a>mon 如何处理上报信息的</h3><p><img src="http://img.rui.vin/202209261104487.png" alt="image-20220922164958665">		</p>
<p><img src="/C:/Users/h00165/AppData/Roaming/Typora/typora-user-images/image-20220922170235620.png" alt="image-20220922170235620">	</p>
<p>和osd接受心跳消息一样，在mon中 也是有一个dispatch 来处理信息，并且也是根据消息类型来处理<br><img src="/C:/Users/h00165/AppData/Roaming/Typora/typora-user-images/image-20220926110653634.png" alt="image-20220926110653634"></p>
<p>最终会调用   <strong>paxos_service[PAXOS_OSDMAP]-&gt;dispatch(op);</strong>   paxos_service 在 mon初始化时候就已经构造好了，可以看到处理reset重新指向了OSDMonitor的类，所以说处理报错消息是由OSDMonitor类的函数处理的；<br><img src="/C:/Users/h00165/AppData/Roaming/Typora/typora-user-images/image-20220926145352556.png" alt="image-20220926145352556"></p>
<p>看看  <strong>paxos_service[PAXOS_OSDMAP]-&gt;dispatch(op)</strong> 是怎么处理的<br>对于上报消息并不是直接处理，而是分为两个步骤</p>
<ul>
<li>预处理  preprocess_query</li>
<li>更行状态 prepare_update</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">PaxosService::dispatch</span><span class="hljs-params">(MonOpRequestRef op)</span></span><br><span class="hljs-function"></span>&#123;<br>........<br>  <span class="hljs-comment">// 预处理 操作</span><br>  <span class="hljs-comment">// preprocess</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">preprocess_query</span>(op)) <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// easy!</span><br>...........<br>.......<br>  <span class="hljs-comment">// update</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">prepare_update</span>(op)) &#123;<br>    <span class="hljs-comment">// no changes made.</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (need_immediate_propose) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="hljs-string">&quot; forced immediate propose&quot;</span> &lt;&lt; dendl;<br>    need_immediate_propose = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">propose_pending</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>......<br>&#125;<br></code></pre></td></tr></table></figure>

<p>先说下  <strong>preprocess_query</strong> </p>
<p>preprocess_query 函数中处理了很多种类型消息，其中  MSG_OSD_FAILURE 对应的处理函数是 <strong>preprocess_failure</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">OSDMonitor::preprocess_query</span><span class="hljs-params">(MonOpRequestRef op)</span></span><br><span class="hljs-function"></span>&#123;<br>  op-&gt;<span class="hljs-built_in">mark_osdmon_event</span>(__func__);<br>  Message *m = op-&gt;<span class="hljs-built_in">get_req</span>();<br>  <span class="hljs-keyword">switch</span> (m-&gt;<span class="hljs-built_in">get_type</span>()) &#123;<br>    <span class="hljs-comment">// READs</span><br>.....<br>    <span class="hljs-comment">// damp updates</span><br>  <span class="hljs-keyword">case</span> MSG_OSD_MARK_ME_DOWN:<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">preprocess_mark_me_down</span>(op);<br>  <span class="hljs-keyword">case</span> MSG_OSD_FULL:<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">preprocess_full</span>(op);<br>  <span class="hljs-keyword">case</span> MSG_OSD_FAILURE:<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">preprocess_failure</span>(op);<br>......<br>  <span class="hljs-keyword">default</span>:<br>    <span class="hljs-built_in">ceph_abort</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终 调用 <strong>preprocess_failure</strong> ，这里多次验证这个消息是否准确的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">OSDMonitor::preprocess_failure</span><span class="hljs-params">(MonOpRequestRef op)</span></span><br><span class="hljs-function"></span>&#123;<br>  op-&gt;<span class="hljs-built_in">mark_osdmon_event</span>(__func__);<br>  MOSDFailure *m = <span class="hljs-built_in">static_cast</span>&lt;MOSDFailure*&gt;(op-&gt;<span class="hljs-built_in">get_req</span>());<br>  <span class="hljs-comment">// who is target_osd</span><br>  <span class="hljs-comment">//获取osd id</span><br>  <span class="hljs-type">int</span> badboy = m-&gt;<span class="hljs-built_in">get_target_osd</span>();<br>  <span class="hljs-comment">// check permissions</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">check_source</span>(op, m-&gt;fsid))<br>    <span class="hljs-keyword">goto</span> didit;<br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;osd test &quot;</span>&lt;&lt; badboy &lt;&lt; dendl;<br>  <span class="hljs-comment">// first, verify the reporting host is valid</span><br>  <span class="hljs-comment">//先从 osdmap中验证有无这个osd</span><br>  <span class="hljs-keyword">if</span> (m-&gt;<span class="hljs-built_in">get_orig_source</span>().<span class="hljs-built_in">is_osd</span>()) &#123;<br>    <span class="hljs-type">int</span> from = m-&gt;<span class="hljs-built_in">get_orig_source</span>().<span class="hljs-built_in">num</span>();<br>    <span class="hljs-keyword">if</span> (!osdmap.<span class="hljs-built_in">exists</span>(from) ||<br>	!osdmap.<span class="hljs-built_in">get_addrs</span>(from).<span class="hljs-built_in">legacy_equals</span>(m-&gt;<span class="hljs-built_in">get_orig_source_addrs</span>()) ||<br>	(osdmap.<span class="hljs-built_in">is_down</span>(from) &amp;&amp; m-&gt;if_osd_failed())) &#123;<br>      <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure from dead osd.&quot;</span> &lt;&lt; from<br>	      &lt;&lt; <span class="hljs-string">&quot;, ignoring&quot;</span> &lt;&lt; dendl;<br>      <span class="hljs-built_in">send_incremental</span>(op, m-&gt;<span class="hljs-built_in">get_epoch</span>()+<span class="hljs-number">1</span>);<br>      <span class="hljs-keyword">goto</span> didit;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// weird?</span><br>  <span class="hljs-comment">//看osd状态 </span><br>  <span class="hljs-keyword">if</span> (osdmap.<span class="hljs-built_in">is_down</span>(badboy)) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure dne(/dup?): osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_addrs</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot;, from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>() &lt;&lt; dendl;<br>    <span class="hljs-keyword">if</span> (m-&gt;<span class="hljs-built_in">get_epoch</span>() &lt; osdmap.<span class="hljs-built_in">get_epoch</span>())<br>      <span class="hljs-built_in">send_incremental</span>(op, m-&gt;<span class="hljs-built_in">get_epoch</span>()+<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">goto</span> didit;<br>  &#125;<br>  <span class="hljs-comment">//核查上报错误osd 的地址</span><br>  <span class="hljs-keyword">if</span> (osdmap.<span class="hljs-built_in">get_addrs</span>(badboy) != m-&gt;<span class="hljs-built_in">get_target_addrs</span>()) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure wrong osd: report osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_addrs</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot; != map&#x27;s &quot;</span> &lt;&lt; osdmap.<span class="hljs-built_in">get_addrs</span>(badboy)<br>	    &lt;&lt; <span class="hljs-string">&quot;, from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>() &lt;&lt; dendl;<br>    <span class="hljs-keyword">if</span> (m-&gt;<span class="hljs-built_in">get_epoch</span>() &lt; osdmap.<span class="hljs-built_in">get_epoch</span>())<br>      <span class="hljs-built_in">send_incremental</span>(op, m-&gt;<span class="hljs-built_in">get_epoch</span>()+<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">goto</span> didit;<br>  &#125;<br><br>  <span class="hljs-comment">// already reported?</span><br>  <span class="hljs-comment">//再次验证 验证epoch</span><br>  <span class="hljs-keyword">if</span> (osdmap.<span class="hljs-built_in">is_down</span>(badboy) ||<br>      osdmap.<span class="hljs-built_in">get_up_from</span>(badboy) &gt; m-&gt;<span class="hljs-built_in">get_epoch</span>()) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure dup/old: osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_addrs</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot;, from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>() &lt;&lt; dendl;<br>    <span class="hljs-keyword">if</span> (m-&gt;<span class="hljs-built_in">get_epoch</span>() &lt; osdmap.<span class="hljs-built_in">get_epoch</span>())<br>      <span class="hljs-built_in">send_incremental</span>(op, m-&gt;<span class="hljs-built_in">get_epoch</span>()+<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">goto</span> didit;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">can_mark_down</span>(badboy)) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure ignoring report of osd.&quot;</span><br>	    &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>() &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_addrs</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot; from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>() &lt;&lt; dendl;<br>    <span class="hljs-keyword">goto</span> didit;<br> &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br> didit:<br>  mon-&gt;<span class="hljs-built_in">no_reply</span>(op);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>验证之后执行 prepare_update，和preprocess_query  一样也是通过消息类型来执行对应的处理函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> <span class="hljs-title function_">OSDMonitor::prepare_update</span><span class="hljs-params">(MonOpRequestRef op)</span><br>&#123;<br>  op-&gt;mark_osdmon_event(__func__);<br>  Message *m = op-&gt;get_req();<br>  dout(<span class="hljs-number">7</span>) &lt;&lt; <span class="hljs-string">&quot;prepare_update &quot;</span> &lt;&lt; *m &lt;&lt; <span class="hljs-string">&quot; from &quot;</span> &lt;&lt; m-&gt;get_orig_source_inst() &lt;&lt; dendl;<br><br>  <span class="hljs-keyword">switch</span> (m-&gt;get_type()) &#123;<br>    <span class="hljs-comment">// damp updates</span><br> .....<br>  <span class="hljs-keyword">case</span> MSG_OSD_FAILURE:<br>    <span class="hljs-keyword">return</span> prepare_failure(op);<br> .....<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p> <strong>prepare_failure</strong>  函数将报告添加到 failure_info中，最后再 check_failure 执行标记osd down的错误</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">OSDMonitor::prepare_failure</span><span class="hljs-params">(MonOpRequestRef op)</span></span><br><span class="hljs-function"></span>&#123;<br>  op-&gt;<span class="hljs-built_in">mark_osdmon_event</span>(__func__);<br>  <span class="hljs-comment">//转换消息类型</span><br>  MOSDFailure *m = <span class="hljs-built_in">static_cast</span>&lt;MOSDFailure*&gt;(op-&gt;<span class="hljs-built_in">get_req</span>());<br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-string">&quot;prepare_failure osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>()<br>	  &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_addrs</span>()<br>	  &lt;&lt; <span class="hljs-string">&quot; from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>()<br>          &lt;&lt; <span class="hljs-string">&quot; is reporting failure:&quot;</span> &lt;&lt; m-&gt;if_osd_failed() &lt;&lt; dendl;<br> <span class="hljs-comment">//获取上报的osd</span><br>  <span class="hljs-type">int</span> target_osd = m-&gt;<span class="hljs-built_in">get_target_osd</span>();<br> <span class="hljs-comment">// </span><br>  <span class="hljs-type">int</span> reporter = m-&gt;<span class="hljs-built_in">get_orig_source</span>().<span class="hljs-built_in">num</span>();<br>  <span class="hljs-built_in">ceph_assert</span>(osdmap.<span class="hljs-built_in">is_up</span>(target_osd));<br>  <span class="hljs-built_in">ceph_assert</span>(osdmap.<span class="hljs-built_in">get_addrs</span>(target_osd) == m-&gt;<span class="hljs-built_in">get_target_addrs</span>());<br><br>  mon-&gt;<span class="hljs-built_in">no_reply</span>(op);<br><br>  <span class="hljs-keyword">if</span> (m-&gt;if_osd_failed()) &#123;<br>    <span class="hljs-comment">// calculate failure time</span><br>    <span class="hljs-type">utime_t</span> now = <span class="hljs-built_in">ceph_clock_now</span>();<br>    <span class="hljs-type">utime_t</span> failed_since =<br>      m-&gt;<span class="hljs-built_in">get_recv_stamp</span>() - <span class="hljs-built_in">utime_t</span>(m-&gt;failed_for, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">// add a report</span><br>    <span class="hljs-keyword">if</span> (m-&gt;<span class="hljs-built_in">is_immediate</span>()) &#123;<br>      mon-&gt;clog-&gt;<span class="hljs-built_in">debug</span>() &lt;&lt; <span class="hljs-string">&quot;osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>()<br>			 &lt;&lt; <span class="hljs-string">&quot; reported immediately failed by &quot;</span><br>			 &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>();<br>      force_failure(target_osd, reporter);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    mon-&gt;clog-&gt;<span class="hljs-built_in">debug</span>() &lt;&lt; <span class="hljs-string">&quot;osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>() &lt;&lt; <span class="hljs-string">&quot; reported failed by &quot;</span><br>		      &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>();<br><br>    <span class="hljs-type">failure_info_t</span>&amp; fi = failure_info[target_osd];<br><br>     <span class="hljs-comment">// 在这个添加失败的报告</span><br>    MonOpRequestRef old_op = fi.<span class="hljs-built_in">add_report</span>(reporter, failed_since, op);<br>    <span class="hljs-keyword">if</span> (old_op) &#123;<br>      mon-&gt;<span class="hljs-built_in">no_reply</span>(old_op);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">check_failure</span>(now, target_osd, fi);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// remove the report</span><br>    mon-&gt;clog-&gt;<span class="hljs-built_in">debug</span>() &lt;&lt; <span class="hljs-string">&quot;osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>()<br>		       &lt;&lt; <span class="hljs-string">&quot; failure report canceled by &quot;</span><br>		       &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>();<br>    <span class="hljs-keyword">if</span> (failure_info.<span class="hljs-built_in">count</span>(target_osd)) &#123;<br>      <span class="hljs-type">failure_info_t</span>&amp; fi = failure_info[target_osd];<br>      MonOpRequestRef report_op = fi.<span class="hljs-built_in">cancel_report</span>(reporter);<br>      <span class="hljs-keyword">if</span> (report_op) &#123;<br>        mon-&gt;<span class="hljs-built_in">no_reply</span>(report_op);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (fi.reporters.<span class="hljs-built_in">empty</span>()) &#123;<br>	<span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot; removing last failure_info for osd.&quot;</span> &lt;&lt; target_osd<br>		 &lt;&lt; dendl;<br>	failure_info.<span class="hljs-built_in">erase</span>(target_osd);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>	<span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot; failure_info for osd.&quot;</span> &lt;&lt; target_osd &lt;&lt; <span class="hljs-string">&quot; now &quot;</span><br>		 &lt;&lt; fi.reporters.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">&quot; reporters&quot;</span> &lt;&lt; dendl;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot; no failure_info for osd.&quot;</span> &lt;&lt; target_osd &lt;&lt; dendl;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>check_failure</strong>  函数并没有直接标记osd 为down，而是通过各种条件来调节  osd 失败的时间，然后再和 实际的osd_heartbeat_grace 做比较，以及上报数量</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">OSDMonitor::check_failure</span><span class="hljs-params">(<span class="hljs-type">utime_t</span> now, <span class="hljs-type">int</span> target_osd, <span class="hljs-type">failure_info_t</span>&amp; fi)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// already pending failure?</span><br>  <span class="hljs-keyword">if</span> (pending_inc.new_state.<span class="hljs-built_in">count</span>(target_osd) &amp;&amp;<br>      pending_inc.new_state[target_osd] &amp; CEPH_OSD_UP) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot; already pending failure&quot;</span> &lt;&lt; dendl;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  set&lt;string&gt; reporters_by_subtree;<br>  <span class="hljs-comment">//故障域</span><br>  <span class="hljs-keyword">auto</span> reporter_subtree_level = <span class="hljs-built_in">g_conf</span>().<span class="hljs-built_in">get_val</span>&lt;string&gt;(<span class="hljs-string">&quot;mon_osd_reporter_subtree_level&quot;</span>);<br>  <span class="hljs-comment">//</span><br>  <span class="hljs-function"><span class="hljs-type">utime_t</span> <span class="hljs-title">orig_grace</span><span class="hljs-params">(g_conf()-&gt;osd_heartbeat_grace, <span class="hljs-number">0</span>)</span></span>;<br>  <span class="hljs-type">utime_t</span> max_failed_since = fi.<span class="hljs-built_in">get_failed_since</span>();<br>  <span class="hljs-type">utime_t</span> failed_for = now - max_failed_since;<br><br>  <span class="hljs-type">utime_t</span> grace = orig_grace;<br>  <span class="hljs-type">double</span> my_grace = <span class="hljs-number">0</span>, peer_grace = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">double</span> decay_k = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">//根据以往 osd的错误报告来 调整下  osd_heartbeat_grace 时间</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">g_conf</span>()-&gt;mon_osd_adjust_heartbeat_grace) &#123;<br> <span class="hljs-comment">// decay_k 为 -0.000192541     ？？？</span><br> <span class="hljs-comment">//::log(.5)  -0.693147</span><br>    <span class="hljs-type">double</span> halflife = (<span class="hljs-type">double</span>)<span class="hljs-built_in">g_conf</span>()-&gt;mon_osd_laggy_halflife;<br>    decay_k = ::<span class="hljs-built_in">log</span>(<span class="hljs-number">.5</span>) / halflife;<br><br>    <span class="hljs-comment">// scale grace period based on historical probability of &#x27;lagginess&#x27;</span><br>    <span class="hljs-comment">//根据历史上的 &quot;滞后性 &quot;概率确定宽限期的规模</span><br>    <span class="hljs-comment">// (false positive failures due to slowness).</span><br><br>    <span class="hljs-type">const</span> <span class="hljs-type">osd_xinfo_t</span>&amp; xi = osdmap.<span class="hljs-built_in">get_xinfo</span>(target_osd);<br>    <span class="hljs-comment">//计算 log ？</span><br>    <span class="hljs-type">double</span> decay = <span class="hljs-built_in">exp</span>((<span class="hljs-type">double</span>)failed_for * decay_k);<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-string">&quot; halflife &quot;</span> &lt;&lt; halflife &lt;&lt; <span class="hljs-string">&quot; decay_k &quot;</span> &lt;&lt; decay_k<br>	     &lt;&lt; <span class="hljs-string">&quot; failed_for &quot;</span> &lt;&lt; failed_for &lt;&lt; <span class="hljs-string">&quot; decay &quot;</span> &lt;&lt; decay &lt;&lt; dendl;<br><br>    my_grace = decay * (<span class="hljs-type">double</span>)xi.laggy_interval * xi.laggy_probability;<br>    grace += my_grace;<br>  &#125;<br><br>  <span class="hljs-comment">// consider the peers reporting a failure a proxy for a potential</span><br>  <span class="hljs-comment">// &#x27;subcluster&#x27; over the overall cluster that is similarly</span><br>  <span class="hljs-comment">// laggy.  this is clearly not true in all cases, but will sometimes</span><br>  <span class="hljs-comment">// help us localize the grace correction to a subset of the system</span><br>  <span class="hljs-comment">// (say, a rack with a bad switch) that is unhappy.</span><br>  <span class="hljs-built_in">ceph_assert</span>(fi.reporters.<span class="hljs-built_in">size</span>());<br>  <span class="hljs-comment">//遍历上报错误</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> p = fi.reporters.<span class="hljs-built_in">begin</span>(); p != fi.reporters.<span class="hljs-built_in">end</span>();) &#123;<br>    <span class="hljs-comment">// get the parent bucket whose type matches with &quot;reporter_subtree_level&quot;.</span><br>    <span class="hljs-comment">// fall back to OSD if the level doesn&#x27;t exist.</span><br>    <span class="hljs-keyword">if</span> (osdmap.<span class="hljs-built_in">exists</span>(p-&gt;first)) &#123;<br>      <span class="hljs-comment">//通过osdmap 获取完整的osd位置</span><br>      <span class="hljs-keyword">auto</span> reporter_loc = osdmap.crush-&gt;<span class="hljs-built_in">get_full_location</span>(p-&gt;first);<br>      <span class="hljs-comment">//不在 指定的故障域</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> iter = reporter_loc.<span class="hljs-built_in">find</span>(reporter_subtree_level);<br>          iter == reporter_loc.<span class="hljs-built_in">end</span>()) &#123;<br>        reporters_by_subtree.<span class="hljs-built_in">insert</span>(<span class="hljs-string">&quot;osd.&quot;</span> + <span class="hljs-built_in">to_string</span>(p-&gt;first));<br><br>        <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt;<span class="hljs-string">&quot;reporters_by_subtree, reporter_subtree_level:&quot;</span> &lt;&lt;reporter_subtree_level <br>                       &lt;&lt; <span class="hljs-string">&quot; vname:&quot;</span> &lt;&lt; <span class="hljs-string">&quot;osd.&quot;</span> + <span class="hljs-built_in">to_string</span>(p-&gt;first) &lt;&lt; dendl;<br>                         <br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        string name = <span class="hljs-built_in">get_phy_name</span>(iter-&gt;second);<br>        <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt;<span class="hljs-string">&quot;reporters_by_subtree, reporter_subtree_level:&quot;</span> &lt;&lt;reporter_subtree_level <br>                       &lt;&lt; <span class="hljs-string">&quot; vname:&quot;</span> &lt;&lt; iter-&gt;second &lt;&lt; <span class="hljs-string">&quot; pname:&quot;</span> &lt;&lt; name &lt;&lt; dendl;<br>         reporters_by_subtree.<span class="hljs-built_in">insert</span>(name);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">g_conf</span>()-&gt;mon_osd_adjust_heartbeat_grace) &#123;<br>        <span class="hljs-type">const</span> <span class="hljs-type">osd_xinfo_t</span>&amp; xi = osdmap.<span class="hljs-built_in">get_xinfo</span>(p-&gt;first);<br>        <span class="hljs-comment">//距离上次标记down的时间</span><br>        <span class="hljs-type">utime_t</span> elapsed = now - xi.down_stamp;<br>        <span class="hljs-type">double</span> decay = <span class="hljs-built_in">exp</span>((<span class="hljs-type">double</span>)elapsed * decay_k);<br>        <span class="hljs-comment">//被标记为滞后和恢复的平均时间间隔</span><br>        peer_grace += decay * (<span class="hljs-type">double</span>)xi.laggy_interval * xi.laggy_probability;<br>      &#125;<br>      ++p;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      fi.<span class="hljs-built_in">cancel_report</span>(p-&gt;first);;<br>      p = fi.reporters.<span class="hljs-built_in">erase</span>(p);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">g_conf</span>()-&gt;mon_osd_adjust_heartbeat_grace) &#123;<br>    peer_grace /= (<span class="hljs-type">double</span>)fi.reporters.<span class="hljs-built_in">size</span>();<br>    grace += peer_grace;<br>  &#125;<br><br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot; osd.&quot;</span> &lt;&lt; target_osd &lt;&lt; <span class="hljs-string">&quot; has &quot;</span><br>	   &lt;&lt; fi.reporters.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">&quot; reporters, &quot;</span><br>	   &lt;&lt; grace &lt;&lt; <span class="hljs-string">&quot; grace (&quot;</span> &lt;&lt; orig_grace &lt;&lt; <span class="hljs-string">&quot; + &quot;</span> &lt;&lt; my_grace<br>	   &lt;&lt; <span class="hljs-string">&quot; + &quot;</span> &lt;&lt; peer_grace &lt;&lt; <span class="hljs-string">&quot;), max_failed_since &quot;</span> &lt;&lt; max_failed_since<br>	   &lt;&lt; dendl;<br><br><span class="hljs-comment">// 以上都是在调整 grace的时间 </span><br><br><span class="hljs-comment">// 实际 osd报错的时间 和 调整过的grace 时间做比较</span><br><span class="hljs-comment">// 以及报错的上报数量</span><br>  <span class="hljs-keyword">if</span> (failed_for &gt;= grace &amp;&amp;<br>      reporters_by_subtree.<span class="hljs-built_in">size</span>() &gt;= <span class="hljs-built_in">g_conf</span>().<span class="hljs-built_in">get_val</span>&lt;<span class="hljs-type">uint64_t</span>&gt;(<span class="hljs-string">&quot;mon_osd_min_down_reporters&quot;</span>)) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-string">&quot; we have enough reporters to mark osd.&quot;</span> &lt;&lt; target_osd<br>	    &lt;&lt; <span class="hljs-string">&quot; down&quot;</span> &lt;&lt; dendl;<br>    <span class="hljs-comment">// 将目标状态标记为 CEPH_OSD_UP，看注释是说 XORed onto previous state，异或？</span><br>    pending_inc.new_state[target_osd] = CEPH_OSD_UP;<br><br>    mon-&gt;clog-&gt;<span class="hljs-built_in">info</span>() &lt;&lt; <span class="hljs-string">&quot;osd.&quot;</span> &lt;&lt; target_osd &lt;&lt; <span class="hljs-string">&quot; failed (&quot;</span><br>		      &lt;&lt; osdmap.crush-&gt;<span class="hljs-built_in">get_full_location_ordered_string</span>(<br>			target_osd)<br>		      &lt;&lt; <span class="hljs-string">&quot;) (&quot;</span><br>		      &lt;&lt; (<span class="hljs-type">int</span>)reporters_by_subtree.<span class="hljs-built_in">size</span>()<br>		      &lt;&lt; <span class="hljs-string">&quot; reporters from different &quot;</span><br>		      &lt;&lt; reporter_subtree_level &lt;&lt; <span class="hljs-string">&quot; after &quot;</span><br>		      &lt;&lt; failed_for &lt;&lt; <span class="hljs-string">&quot; &gt;= grace &quot;</span> &lt;&lt; grace &lt;&lt; <span class="hljs-string">&quot;)&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>







<p>让后执行<br><strong>bool PaxosService::dispatch(MonOpRequestRef op)</strong></p>
<p><img src="http://img.rui.vin/202209271607817.png" alt="image-20220926140755087">	</p>
<p><img src="/C:/Users/h00165/AppData/Roaming/Typora/typora-user-images/image-20220926140802665.png" alt="image-20220926140802665">	</p>
<p><img src="/C:/Users/h00165/AppData/Roaming/Typora/typora-user-images/image-20220926140809506.png" alt="image-20220926140809506">	</p>
<p>OSDMonitor::preprocess_query(MonOpRequestRef op)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">OSDMonitor::preprocess_query</span><span class="hljs-params">(MonOpRequestRef op)</span></span><br><span class="hljs-function"></span>&#123;<br>  op-&gt;<span class="hljs-built_in">mark_osdmon_event</span>(__func__);<br>  <span class="hljs-comment">//取得 message</span><br>  Message *m = op-&gt;<span class="hljs-built_in">get_req</span>();<br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_query &quot;</span> &lt;&lt; *m &lt;&lt; <span class="hljs-string">&quot; from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source_inst</span>() &lt;&lt; dendl;<br>  <span class="hljs-comment">//判断 message类性</span><br>  <span class="hljs-keyword">switch</span> (m-&gt;<span class="hljs-built_in">get_type</span>()) &#123;<br>.....<br>  <span class="hljs-comment">//osd上报错误的处理函数</span><br>  <span class="hljs-keyword">case</span> MSG_OSD_FAILURE:<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">preprocess_failure</span>(op);<br>.......<br>  <span class="hljs-keyword">default</span>:<br>    <span class="hljs-built_in">ceph_abort</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">OSDMonitor::preprocess_failure</span><span class="hljs-params">(MonOpRequestRef op)</span></span><br><span class="hljs-function"></span>&#123;<br>  op-&gt;<span class="hljs-built_in">mark_osdmon_event</span>(__func__);<br>  MOSDFailure *m = <span class="hljs-built_in">static_cast</span>&lt;MOSDFailure*&gt;(op-&gt;<span class="hljs-built_in">get_req</span>());<br>  <span class="hljs-comment">// who is target_osd</span><br>  <span class="hljs-type">int</span> badboy = m-&gt;<span class="hljs-built_in">get_target_osd</span>();<br><br>  <span class="hljs-comment">// check permissions</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">check_source</span>(op, m-&gt;fsid))<br>    <span class="hljs-keyword">goto</span> didit;<br><br>  <span class="hljs-comment">// first, verify the reporting host is valid</span><br>  <span class="hljs-keyword">if</span> (m-&gt;<span class="hljs-built_in">get_orig_source</span>().<span class="hljs-built_in">is_osd</span>()) &#123;<br>    <span class="hljs-type">int</span> from = m-&gt;<span class="hljs-built_in">get_orig_source</span>().<span class="hljs-built_in">num</span>();<br>    <span class="hljs-keyword">if</span> (!osdmap.<span class="hljs-built_in">exists</span>(from) ||<br>	!osdmap.<span class="hljs-built_in">get_addrs</span>(from).<span class="hljs-built_in">legacy_equals</span>(m-&gt;<span class="hljs-built_in">get_orig_source_addrs</span>()) ||<br>	(osdmap.<span class="hljs-built_in">is_down</span>(from) &amp;&amp; m-&gt;if_osd_failed())) &#123;<br>      <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure from dead osd.&quot;</span> &lt;&lt; from<br>	      &lt;&lt; <span class="hljs-string">&quot;, ignoring&quot;</span> &lt;&lt; dendl;<br>      <span class="hljs-built_in">send_incremental</span>(op, m-&gt;<span class="hljs-built_in">get_epoch</span>()+<span class="hljs-number">1</span>);<br>      <span class="hljs-keyword">goto</span> didit;<br>    &#125;<br>  &#125;<br><br><br>  <span class="hljs-comment">// weird?</span><br>  <span class="hljs-keyword">if</span> (osdmap.<span class="hljs-built_in">is_down</span>(badboy)) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure dne(/dup?): osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_addrs</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot;, from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>() &lt;&lt; dendl;<br>    <span class="hljs-keyword">if</span> (m-&gt;<span class="hljs-built_in">get_epoch</span>() &lt; osdmap.<span class="hljs-built_in">get_epoch</span>())<br>      <span class="hljs-built_in">send_incremental</span>(op, m-&gt;<span class="hljs-built_in">get_epoch</span>()+<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">goto</span> didit;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (osdmap.<span class="hljs-built_in">get_addrs</span>(badboy) != m-&gt;<span class="hljs-built_in">get_target_addrs</span>()) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure wrong osd: report osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_addrs</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot; != map&#x27;s &quot;</span> &lt;&lt; osdmap.<span class="hljs-built_in">get_addrs</span>(badboy)<br>	    &lt;&lt; <span class="hljs-string">&quot;, from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>() &lt;&lt; dendl;<br>    <span class="hljs-keyword">if</span> (m-&gt;<span class="hljs-built_in">get_epoch</span>() &lt; osdmap.<span class="hljs-built_in">get_epoch</span>())<br>      <span class="hljs-built_in">send_incremental</span>(op, m-&gt;<span class="hljs-built_in">get_epoch</span>()+<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">goto</span> didit;<br>  &#125;<br><br>  <span class="hljs-comment">// already reported?</span><br>  <span class="hljs-keyword">if</span> (osdmap.<span class="hljs-built_in">is_down</span>(badboy) ||<br>      osdmap.<span class="hljs-built_in">get_up_from</span>(badboy) &gt; m-&gt;<span class="hljs-built_in">get_epoch</span>()) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure dup/old: osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_addrs</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot;, from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>() &lt;&lt; dendl;<br>    <span class="hljs-keyword">if</span> (m-&gt;<span class="hljs-built_in">get_epoch</span>() &lt; osdmap.<span class="hljs-built_in">get_epoch</span>())<br>      <span class="hljs-built_in">send_incremental</span>(op, m-&gt;<span class="hljs-built_in">get_epoch</span>()+<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">goto</span> didit;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">can_mark_down</span>(badboy)) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure ignoring report of osd.&quot;</span><br>	    &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>() &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_addrs</span>()<br>	    &lt;&lt; <span class="hljs-string">&quot; from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>() &lt;&lt; dendl;<br>    <span class="hljs-keyword">goto</span> didit;<br>  &#125;<br><br>  <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot;preprocess_failure new: osd.&quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_osd</span>()<br>	   &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_target_addrs</span>()<br>	   &lt;&lt; <span class="hljs-string">&quot;, from &quot;</span> &lt;&lt; m-&gt;<span class="hljs-built_in">get_orig_source</span>() &lt;&lt; dendl;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br> didit:<br>  mon-&gt;<span class="hljs-built_in">no_reply</span>(op);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">OSDMonitor::check_failure</span><span class="hljs-params">(<span class="hljs-type">utime_t</span> now, <span class="hljs-type">int</span> target_osd, <span class="hljs-type">failure_info_t</span>&amp; fi)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">// already pending failure?</span><br>  <span class="hljs-keyword">if</span> (pending_inc.new_state.<span class="hljs-built_in">count</span>(target_osd) &amp;&amp;<br>      pending_inc.new_state[target_osd] &amp; CEPH_OSD_UP) &#123;<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">10</span>) &lt;&lt; <span class="hljs-string">&quot; already pending failure&quot;</span> &lt;&lt; dendl;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  set&lt;string&gt; reporters_by_subtree;<br>  <span class="hljs-comment">//故障域</span><br>  <span class="hljs-keyword">auto</span> reporter_subtree_level = <span class="hljs-built_in">g_conf</span>().<span class="hljs-built_in">get_val</span>&lt;string&gt;(<span class="hljs-string">&quot;mon_osd_reporter_subtree_level&quot;</span>);<br>  <span class="hljs-comment">//</span><br>  <span class="hljs-function"><span class="hljs-type">utime_t</span> <span class="hljs-title">orig_grace</span><span class="hljs-params">(g_conf()-&gt;osd_heartbeat_grace, <span class="hljs-number">0</span>)</span></span>;<br>  <span class="hljs-type">utime_t</span> max_failed_since = fi.<span class="hljs-built_in">get_failed_since</span>();<br>  <span class="hljs-type">utime_t</span> failed_for = now - max_failed_since;<br><br>  <span class="hljs-type">utime_t</span> grace = orig_grace;<br>  <span class="hljs-type">double</span> my_grace = <span class="hljs-number">0</span>, peer_grace = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">double</span> decay_k = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">//根据以往 osd的错误报告来 调整下  osd_heartbeat_grace 时间</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">g_conf</span>()-&gt;mon_osd_adjust_heartbeat_grace) &#123;<br> <span class="hljs-comment">// decay_k 为 -0.000192541     ？？？</span><br> <span class="hljs-comment">//::log(.5)  -0.693147</span><br>    <span class="hljs-type">double</span> halflife = (<span class="hljs-type">double</span>)<span class="hljs-built_in">g_conf</span>()-&gt;mon_osd_laggy_halflife;<br>    decay_k = ::<span class="hljs-built_in">log</span>(<span class="hljs-number">.5</span>) / halflife;<br><br>    <span class="hljs-comment">// scale grace period based on historical probability of &#x27;lagginess&#x27;</span><br>    <span class="hljs-comment">//根据历史上的 &quot;滞后性 &quot;概率确定宽限期的规模</span><br>    <span class="hljs-comment">// (false positive failures due to slowness).</span><br><br>    <span class="hljs-type">const</span> <span class="hljs-type">osd_xinfo_t</span>&amp; xi = osdmap.<span class="hljs-built_in">get_xinfo</span>(target_osd);<br>    <span class="hljs-comment">//计算 log ？</span><br>    <span class="hljs-type">double</span> decay = <span class="hljs-built_in">exp</span>((<span class="hljs-type">double</span>)failed_for * decay_k);<br>    <span class="hljs-built_in">dout</span>(<span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-string">&quot; halflife &quot;</span> &lt;&lt; halflife &lt;&lt; <span class="hljs-string">&quot; decay_k &quot;</span> &lt;&lt; decay_k<br>	     &lt;&lt; <span class="hljs-string">&quot; failed_for &quot;</span> &lt;&lt; failed_for &lt;&lt; <span class="hljs-string">&quot; decay &quot;</span> &lt;&lt; decay &lt;&lt; dendl;<br><br>    my_grace = decay * (<span class="hljs-type">double</span>)xi.laggy_interval * xi.laggy_probability;<br>    grace += my_grace;<br>  &#125;<br>  <span class="hljs-comment">//遍历上报错误</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> p = fi.reporters.<span class="hljs-built_in">begin</span>(); p != fi.reporters.<span class="hljs-built_in">end</span>();) &#123;<br>    <span class="hljs-comment">// get the parent bucket whose type matches with &quot;reporter_subtree_level&quot;.</span><br>    <span class="hljs-comment">// fall back to OSD if the level doesn&#x27;t exist.</span><br>    <span class="hljs-keyword">if</span> (osdmap.<span class="hljs-built_in">exists</span>(p-&gt;first)) &#123;<br>      <span class="hljs-comment">//通过osdmap 获取完整的osd位置</span><br>      <span class="hljs-keyword">auto</span> reporter_loc = osdmap.crush-&gt;<span class="hljs-built_in">get_full_location</span>(p-&gt;first);<br>      <span class="hljs-comment">//不在 指定的故障域</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> iter = reporter_loc.<span class="hljs-built_in">find</span>(reporter_subtree_level);<br>          iter == reporter_loc.<span class="hljs-built_in">end</span>()) &#123;<br>        reporters_by_subtree.<span class="hljs-built_in">insert</span>(<span class="hljs-string">&quot;osd.&quot;</span> + <span class="hljs-built_in">to_string</span>(p-&gt;first));<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        string name = <span class="hljs-built_in">get_phy_name</span>(iter-&gt;second);<br>           reporters_by_subtree.<span class="hljs-built_in">insert</span>(name);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">g_conf</span>()-&gt;mon_osd_adjust_heartbeat_grace) &#123;<br>        <span class="hljs-type">const</span> <span class="hljs-type">osd_xinfo_t</span>&amp; xi = osdmap.<span class="hljs-built_in">get_xinfo</span>(p-&gt;first);<br>        <span class="hljs-comment">//距离上次标记down的时间</span><br>        <span class="hljs-type">utime_t</span> elapsed = now - xi.down_stamp;<br>        <span class="hljs-type">double</span> decay = <span class="hljs-built_in">exp</span>((<span class="hljs-type">double</span>)elapsed * decay_k);<br>        <span class="hljs-comment">//被标记为滞后和恢复的平均时间间隔</span><br>        peer_grace += decay * (<span class="hljs-type">double</span>)xi.laggy_interval * xi.laggy_probability;<br>      &#125;<br>      ++p;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      fi.<span class="hljs-built_in">cancel_report</span>(p-&gt;first);;<br>      p = fi.reporters.<span class="hljs-built_in">erase</span>(p);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">g_conf</span>()-&gt;mon_osd_adjust_heartbeat_grace) &#123;<br>    peer_grace /= (<span class="hljs-type">double</span>)fi.reporters.<span class="hljs-built_in">size</span>();<br>    grace += peer_grace;<br>  &#125;<br><span class="hljs-comment">// 以上都是在调整 grace的时间 </span><br><br><span class="hljs-comment">// 实际 osd报错的时间 和 调整过的grace 时间做比较</span><br><span class="hljs-comment">// 以及报错的上报数量</span><br>  <span class="hljs-keyword">if</span> (failed_for &gt;= grace &amp;&amp;<br>      reporters_by_subtree.<span class="hljs-built_in">size</span>() &gt;= <span class="hljs-built_in">g_conf</span>().<span class="hljs-built_in">get_val</span>&lt;<span class="hljs-type">uint64_t</span>&gt;(<span class="hljs-string">&quot;mon_osd_min_down_reporters&quot;</span>)) &#123;<br>   <br>    <span class="hljs-comment">// 将目标状态标记为 CEPH_OSD_UP，看注释是说 XORed onto previous state，异或？</span><br>    pending_inc.new_state[target_osd] = CEPH_OSD_UP;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>一类是同个PG下的OSD节点之间</p>
<p>另一类是OSD的左右两个相邻的节点，</p>
<p>可以用于节点间检测对方是否故障，以便及时发现故障节点后进入相应的故障处理流程。</p>
<p>每个OSD节点（守护进程）会监听public、cluster、front和back四个端口</p>
<ul>
<li>public端口：监听来自Monitor和Client的连接。</li>
<li>cluster端口：监听来自OSD Peer的连接（同一个集群内的osd）。</li>
<li>front端口：供客户端连接集群使用的网卡, 这里临时给集群内部之间进行心跳。</li>
<li>back端口：供客集群内部使用的网卡。集群内部之间进行心跳。</li>
</ul>
<p>每个 Ceph OSD 守护进程每 6 秒检查其他 Ceph OSD 守护进程的心跳。要更改心跳间隔，请在 Ceph 配置文件的 <code>[osd]</code> 部分下添加 <code>osd heartbeat interval</code> 设置，或者在运行时更改其值。</p>
<p>如果邻居 Ceph OSD 守护进程未在 20 秒宽限期内发送 heartbeat 数据包，Ceph OSD 守护进程可能会考虑相邻的 Ceph OSD 守护进程 <code>停机</code>。它将报告回 Ceph 监控器，后者将更新 Ceph 群集映射。若要更改此宽限期，可在 Ceph 配置文件的 <code>[osd]</code> 部分下添加 <code>osd heartbeat 宽限期</code>，或者在运行时设置其值。</p>
<p><img src="http://img.rui.vin/202209141140073.png" alt="image-20220914114020984">	</p>
<p>osd 之间心跳机制：osd之间会互相通信，通信间隔时间在随机 6s以内；如果在20s后没有收到osd没有收到相邻的osd心跳，会认为相邻的osd已经 dowm，并报告给 mon；</p>
<img src="http://imt.rui.vin/202209121823055.png" alt="image-20220912181919117" style="zoom:80%;">	

<p>osd和mon之间的心跳机制：  </p>
<ul>
<li>向mon 上报 osd down信息，mon判断机制是收到两个以上某个osd dowm的信息</li>
</ul>
<p><img src="http://imt.rui.vin/202209121823048.png" alt="image-20220912182244414">		</p>
<ul>
<li>上报 osd 状态，变更信息，不管osd 有没有变更信息，每个120s都要上报一次</li>
</ul>
<p><img src="/C:/Users/hrp/AppData/Roaming/Typora/typora-user-images/image-20220912182611844.png" alt="image-20220912182611844">	</p>
<ul>
<li>当 获取不到 邻居osd信息时，上报给mon获取新的 osdmap</li>
</ul>
<p><img src="/C:/Users/hrp/AppData/Roaming/Typora/typora-user-images/image-20220912182528403.png" alt="image-20220912182528403"></p>
<p><img src="http://img.rui.vin/202209131747251.png" alt="image-20220913174728093">	</p>
<p><img src="http://img.rui.vin/202209071600481.png" alt="image-20220907160040430">	</p>
<p><img src="http://img.rui.vin/202209071650942.png" alt="image-20220907165035868">	</p>
<p>  \</p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ceph/">#ceph</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/25/ceph/%5Bceph%5D%20%E6%A8%A1%E5%9D%97%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%AD%E7%9A%84prefork/" title="ceph-模块初始化中 prefork源码解析">
                        <span class="hidden-mobile">ceph-模块初始化中 prefork源码解析</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments">
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.18/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"4tz8f6FTi0BVSOcKQPAnAAkg-gzGzoHsz","appKey":"ltYlWD7ItrDou5czyO7XrpbJ","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        Views: 
        <span id="busuanzi_value_site_pv"></span>
        
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        Visitors: 
        <span id="busuanzi_value_site_uv"></span>
        
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      粤ICP备2022011229号
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" alt="police-icon"/>
          
          <span>粤ICP备2022011229号</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  

  

  

  

  

  

  







  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
